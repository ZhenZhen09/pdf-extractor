<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PDF Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center py-12">

    <div class="w-full max-w-4xl px-4">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800">PDF to Table Converter</h1>
            <p class="text-slate-500 mt-2">Upload PDF invoices or reports to extract data instantly.</p>
        </div>

        <!-- File Input -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 mb-8">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <label
                    class="block w-full text-sm text-slate-500 bg-white border border-slate-200 rounded-lg p-3 cursor-pointer hover:bg-slate-50">
                    Select PDF files
                    <input type="file" id="fileInput" accept="application/pdf" multiple class="hidden" />
                </label>
                <button onclick="processFiles()" id="uploadBtn"
                    class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Extract Data
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-2">Hold Ctrl (Windows) or Cmd (Mac) to select multiple files.</p>
        </div>

        <!-- Progress Bar -->
        <div id="progressContainer" class="w-full bg-slate-200 rounded-lg h-4 mb-4 hidden">
            <div id="progressBar" class="bg-blue-600 h-4 rounded-lg w-0 text-xs text-white text-center"></div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="hidden flex-col items-center justify-center py-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
            <p class="text-slate-500 mt-3 animate-pulse">Analyzing document structure...</p>
        </div>

        <!-- Result Table -->
        <div id="resultArea" class="hidden bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50" id="tableHead"></thead>
                    <tbody class="divide-y divide-slate-200" id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (!files || files.length === 0) {
                alert("Please select at least one PDF file.");
                return;
            }

            // UI toggle
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').innerText = "Processing...";

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = "0%";
            progressBar.innerText = "0%";

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
            }

            try {
                const response = await fetch('/extract', { method: 'POST', body: formData });
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // Update progress bar based on actual file progress from backend
                for (let i = 0; i < data.file_progress.length; i++) {
                    const percent = data.file_progress[i].progress;
                    progressBar.style.width = percent + "%";
                    progressBar.innerText = percent + "%";
                    await new Promise(r => setTimeout(r, 300)); // slight delay to visualize
                }

                buildTable(data);

            } catch (error) {
                progressBar.style.width = "0%";
                progressBar.innerText = "0%";
                alert("Error: " + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerText = "Extract Data";
            }
        }

        function buildTable(data) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const rows = data.table_data;
            if (!rows || rows.length === 0) {
                alert("No table data found.");
                return;
            }

            const headers = [
                "Customer Name",
                "Transaction Number",
                "Invoice Number",
                "Original/Bal Amount",
                "WHT Amount",
                "Paid Amount (NET)",
                "Description"
            ];

            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = "px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider";
                th.innerText = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            rows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = "px-6 py-4 whitespace-nowrap text-sm text-slate-700";
                    td.innerText = row[header] || "-";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('resultArea').classList.remove('hidden');
        }
    </script>
</body>

</html>